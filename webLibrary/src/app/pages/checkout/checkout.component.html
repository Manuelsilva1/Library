<div class="checkout-container">
  <h1 class="page-title">Finalizar Compra</h1>

  <div class="checkout-grid" *ngIf="cartItems.length > 0; else emptyCartMessage">
    <!-- Columna Izquierda: Formularios y Selección -->
    <div class="checkout-forms">
      <h2 class="section-title">Dirección de Envío</h2>
      <form [formGroup]="checkoutForm" (ngSubmit)="onSubmit()">
        <div class="form-grid">
          <mat-form-field appearance="outline">
            <mat-label>Línea de Dirección 1</mat-label>
            <input matInput formControlName="shippingAddressLine1" required>
            <mat-error *ngIf="checkoutForm.get('shippingAddressLine1')?.hasError('required')">
              Dirección es requerida
            </mat-error>
          </mat-form-field>

          <mat-form-field appearance="outline">
            <mat-label>Línea de Dirección 2 (Opcional)</mat-label>
            <input matInput formControlName="shippingAddressLine2">
          </mat-form-field>

          <mat-form-field appearance="outline">
            <mat-label>Ciudad</mat-label>
            <input matInput formControlName="shippingCity" required>
            <mat-error *ngIf="checkoutForm.get('shippingCity')?.hasError('required')">
              Ciudad es requerida
            </mat-error>
          </mat-form-field>

          <mat-form-field appearance="outline">
            <mat-label>Código Postal</mat-label>
            <input matInput formControlName="shippingPostalCode" required>
            <mat-error *ngIf="checkoutForm.get('shippingPostalCode')?.hasError('required')">
              Código Postal es requerido
            </mat-error>
          </mat-form-field>

          <mat-form-field appearance="outline">
             <mat-label>País</mat-label>
             <input matInput formControlName="shippingCountry" required>
             <mat-error *ngIf="checkoutForm.get('shippingCountry')?.hasError('required')">
               País es requerido
             </mat-error>
          </mat-form-field>
        </div>

        <div class="alert alert-danger mt-3" *ngIf="errorMessage">
          {{ errorMessage }}
        </div>

        <div class="form-actions">
          <button mat-flat-button color="primary" type="submit" [disabled]="checkoutForm.invalid || isLoading || cartItems.length === 0">
            <span *ngIf="!isLoading">Realizar Pedido</span>
            <span *ngIf="isLoading">
              <mat-progress-spinner mode="indeterminate" diameter="20"></mat-progress-spinner> Procesando...
            </span>
          </button>
        </div>
      </form>
    </div>

    <!-- Columna Derecha: Resumen del Pedido -->
    <div class="order-summary">
      <h3 class="summary-title">Resumen de tu Pedido</h3>
      <mat-card class="summary-card">
        <mat-list *ngIf="cartItems.length > 0">
          <mat-list-item *ngFor="let item of cartItems">
            <img matListItemAvatar [src]="item.book.coverImageUrl || 'assets/images/default-cover.png'" [alt]="item.book.title" class="summary-item-image">
            <div matListItemTitle class="summary-item-title">{{ item.book.title }} (x{{ item.quantity }})</div>
            <div matListItemLine class="summary-item-author">{{ item.book.author }}</div>
            <span matListItemMeta class="summary-item-price">{{ (item.book.price * item.quantity) | currency:'USD' }}</span>
          </mat-list-item>
        </mat-list>
        
        <mat-divider *ngIf="cartItems.length > 0"></mat-divider>
        
        <div class="summary-totals" *ngIf="cartItems.length > 0">
          <p class="grand-total">Total: <strong>{{ totalPrice | currency:'USD' }}</strong></p>
        </div>
        <div *ngIf="cartItems.length === 0" class="empty-cart-summary-box">
           Tu carrito está vacío.
        </div>
      </mat-card>
      <a mat-stroked-button routerLink="/catalogo" class="continue-shopping-link">
        <i-tabler name="arrow-left" class="icon-20"></i-tabler> Continuar Comprando
      </a>
    </div>
  </div>
</div>

<ng-template #emptyCartMessage>
  <div class="empty-cart-fullpage">
    <i-tabler name="shopping-cart-x" class="icon-extra-large"></i-tabler>
    <h2>Tu carrito está vacío</h2>
    <p>No puedes proceder al checkout sin items en tu carrito.</p>
    <a mat-flat-button color="primary" routerLink="/catalogo">Volver al Catálogo</a>
  </div>
</ng-template>
